@startuml "Sales Demand Forecasting - LLD Architecture"

!define RECTANGLE class
skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle

title Sales Demand Forecasting - Integration Architecture\nODH Trainer + Kubeflow SDK + Feast

' Color definitions
skinparam component {
    BackgroundColor<<platform>> #E8F5E9
    BackgroundColor<<sdk>> #E3F2FD
    BackgroundColor<<feast>> #FFF3E0
    BackgroundColor<<training>> #FCE4EC
    BackgroundColor<<storage>> #F3E5F5
}

package "OpenShift AI Platform" <<platform>> {
    
    package "User Interface Layer" {
        [Jupyter Workbench] as workbench
        note right of workbench
            Notebooks:
            01_data_preparation
            02_distributed_training
            03_model_evaluation
        end note
    }
    
    package "SDK Layer" <<sdk>> {
        [TrainerClient] as sdk
        note right of sdk
            opendatahub-io/kubeflow-sdk
            v0.2.1+rhai2
            ---
            create_job()
            get_job()
            get_job_logs()
            delete_job()
        end note
    }
    
    package "Training Operator Layer" <<training>> {
        [Kubeflow Trainer Controller] as controller
        note right of controller
            opendatahub-io/trainer
            v2.0 (odh-3.3)
            ---
            Manages:
            - PyTorchJob
            - TrainJob (v1alpha1)
        end note
        
        package "Training Pods" {
            [Master Pod\n(Rank 0)] as master
            [Worker Pod\n(Rank 1)] as worker
        }
    }
    
    package "Feature Store Layer" <<feast>> {
        [Feast SDK] as feast_sdk
        note right of feast_sdk
            feast-dev/feast
            v0.59.0
            ---
            get_historical_features()
            get_online_features()
            materialize()
        end note
        
        package "Feast Storage" {
            database "Registry\n(PostgreSQL)" as registry
            database "Offline Store\n(PostgreSQL)" as offline
            database "Online Store\n(PostgreSQL)" as online
        }
        
        [Ray Compute Engine] as ray
        note bottom of ray
            Distributed joins
            On-demand transforms
            8 workers
        end note
    }
    
    package "Persistent Storage" <<storage>> {
        storage "shared-storage\n(PVC - RWX)" as pvc {
            folder "feature_repo/" as repo
            folder "models/" as models
        }
    }
}

' Relationships
workbench --> sdk : "1. create_job()"
sdk --> controller : "2. PyTorchJob CR"
controller --> master : "3. Schedule"
controller --> worker : "3. Schedule"

master <--> worker : "4. PyTorch DDP\n(NCCL/gloo)"

master --> feast_sdk : "5. get_historical_features()"
feast_sdk --> offline : "6. SQL Query"
feast_sdk --> ray : "7. Parallel Joins"
ray --> offline : "Read"

master --> pvc : "8. Save chunks\n& model"
worker --> pvc : "Read chunks"

' Inference flow
feast_sdk --> online : "get_online_features()"
feast_sdk --> registry : "Feature metadata"

@enduml

