%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#1e3a5f',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#3d5a80',
    'lineColor': '#ee6c4d',
    'secondaryColor': '#293241',
    'tertiaryColor': '#98c1d9',
    'background': '#f4f4f4',
    'fontFamily': 'JetBrains Mono, monospace'
  }
}}%%

flowchart TB
    subgraph PREREQS["<b>ðŸ”§ PHASE 0: Prerequisites</b>"]
        direction TB
        P1["00-prereqs.yaml<br/>Namespace, RBAC, PVC"]
        P2["01-postgres.yaml<br/>PostgreSQL for Feast"]
        P3["02-mlflow.yaml<br/>MLflow Tracking Server"]
        P4["03-raycluster.yaml<br/>RayCluster: feast-ray"]
        P5["04-feast-prereqs.yaml<br/>ServiceAccount, Token"]
        
        P1 --> P2 --> P3 --> P4 --> P5
    end

    subgraph DATAPREP["<b>ðŸ“Š PHASE 1: Data Preparation (RayJob #1)</b>"]
        direction TB
        D1["05-dataprep-job.yaml<br/>Kubernetes Job"]
        
        subgraph RAY1["RayCluster: feast-ray"]
            direction LR
            R1H["Head Node<br/>ray://feast-ray:10001"]
            R1W["Workers<br/>Distributed Tasks"]
        end
        
        D2["Generate Sales Data<br/>~93K+ records"]
        D3["Write to Parquet<br/>/shared/data/*.parquet"]
        D4["feast apply<br/>Register features in PostgreSQL"]
        D5["feast materialize<br/>Ray Distributed"]
        D6["Write to PostgreSQL Online Store"]
        
        D1 --> D2
        D2 --> D3
        D3 --> D4
        D4 --> D5
        D5 -.->|"Uses Ray Compute Engine"| RAY1
        D5 --> D6
    end

    subgraph TRAINING["<b>ðŸŽ¯ PHASE 2: Model Training (Kubeflow TrainJob)</b>"]
        direction TB
        T1["06-trainjob.yaml<br/>TrainJob: sales-forecasting"]
        
        subgraph FEAST_HIST["Feast Historical Features"]
            direction LR
            F1["get_historical_features()"]
            F2["Ray PIT Joins"]
        end
        
        T2["Load Entity DataFrame"]
        T3["Feature Retrieval<br/>sales_features + store_features"]
        T4["Train PyTorch Model<br/>DDP Distributed"]
        T5["Log to MLflow<br/>Metrics, Params, Artifacts"]
        T6["Register Model<br/>MLflow Model Registry"]
        
        T1 --> T2
        T2 --> FEAST_HIST
        FEAST_HIST -.->|"Uses Ray Compute Engine"| RAY1
        FEAST_HIST --> T3
        T3 --> T4 --> T5 --> T6
    end

    subgraph REGISTRY["<b>ðŸ“¦ PHASE 3: Model Registry</b>"]
        direction TB
        MR1["07-model-registry.yaml<br/>OpenShift AI Model Registry"]
        MR2["Model Artifact URI<br/>s3://mlflow/models/..."]
        MR3["Model Version<br/>v1.0.0"]
        
        MR1 --> MR2 --> MR3
    end

    subgraph INFERENCE["<b>ðŸš€ PHASE 4: Inference (KServe)</b>"]
        direction TB
        I1["08-kserve-inference.yaml<br/>InferenceService"]
        I2["Load Model from MLflow"]
        
        subgraph FEAST_ONLINE["Feast Online Features"]
            direction LR
            FO1["get_online_features()"]
            FO2["PostgreSQL Query<br/>(Low Latency)"]
        end
        
        I3["Real-time Predictions"]
        
        I1 --> I2
        I2 --> FEAST_ONLINE
        FEAST_ONLINE --> I3
    end

    subgraph STORAGE["<b>ðŸ’¾ Storage Components</b>"]
        direction LR
        S1[("PostgreSQL<br/>Registry + Online Store")]
        S2[("Shared PVC<br/>Parquet Files")]
        S3[("MLflow<br/>Artifacts")]
    end

    %% Connections between phases
    PREREQS --> DATAPREP
    DATAPREP --> TRAINING
    TRAINING --> REGISTRY
    REGISTRY --> INFERENCE

    %% Storage connections
    D3 -.-> S2
    D4 -.-> S1
    D6 -.-> S1
    T5 -.-> S3
    I2 -.-> S3
    FEAST_ONLINE -.-> S1

    %% Styling
    classDef prereq fill:#293241,stroke:#3d5a80,color:#ffffff
    classDef dataprep fill:#1e3a5f,stroke:#3d5a80,color:#ffffff
    classDef training fill:#ee6c4d,stroke:#f77f00,color:#ffffff
    classDef registry fill:#3d5a80,stroke:#98c1d9,color:#ffffff
    classDef inference fill:#2a9d8f,stroke:#264653,color:#ffffff
    classDef storage fill:#e9c46a,stroke:#f4a261,color:#264653
    classDef ray fill:#7209b7,stroke:#560bad,color:#ffffff

    class P1,P2,P3,P4,P5 prereq
    class D1,D2,D3,D4,D5,D6 dataprep
    class T1,T2,T3,T4,T5,T6 training
    class MR1,MR2,MR3 registry
    class I1,I2,I3 inference
    class S1,S2,S3 storage
    class R1H,R1W,F1,F2,FO1,FO2 ray

