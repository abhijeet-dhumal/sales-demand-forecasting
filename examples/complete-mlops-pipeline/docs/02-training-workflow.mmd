%%{init: {
  'theme': 'base',
  'themeVariables': {
    'primaryColor': '#e3f2fd',
    'primaryTextColor': '#1a1a1a',
    'primaryBorderColor': '#90caf9',
    'lineColor': '#455a64'
  }
}}%%
flowchart LR
    %% Main unidirectional flow
    A["ğŸ“‚ <b>Entity DataFrame</b><br/><i>store_id, dept_id, timestamp</i>"]
    B["ğŸ• <b>get_historical_features</b><br/><i>Point-in-time joins via Ray</i>"]
    C["âš™ï¸ <b>Preprocess</b><br/><i>Scale + Train/Val split</i>"]
    D["ğŸ¯ <b>Train PyTorch</b><br/><i>DDP on 2 nodes</i>"]
    E["ğŸ’¾ <b>Save Artifacts</b><br/><i>model.pt + scalers.joblib</i>"]
    F["ğŸ“ˆ <b>Log MLflow</b><br/><i>metrics, params, model</i>"]
    G["âœ… <b>Done</b><br/><i>MAPE ~3%</i>"]

    A -->|"entities"| B -->|"training_df"| C -->|"tensors"| D -->|"best_model"| E -->|"log"| F -->|"complete"| G

    %% Infrastructure (below)
    Feast["ğŸ• Feast"]
    Ray["âš¡ KubeRay"]
    PVC[("ğŸ’¾ Shared PVC")]
    MLF["ğŸ“ˆ MLflow"]

    B -.->|"query"| Feast
    Feast -.->|"distribute"| Ray
    E -.->|"save"| PVC
    F -.->|"track"| MLF

    style A fill:#e8f5e9,stroke:#81c784,stroke-width:2px
    style B fill:#e3f2fd,stroke:#90caf9,stroke-width:2px
    style C fill:#e3f2fd,stroke:#90caf9,stroke-width:2px
    style D fill:#fff3e0,stroke:#ffcc80,stroke-width:2px
    style E fill:#f3e5f5,stroke:#ce93d8,stroke-width:2px
    style F fill:#f3e5f5,stroke:#ce93d8,stroke-width:2px
    style G fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    style Feast fill:#fafafa,stroke:#bdbdbd
    style Ray fill:#fafafa,stroke:#bdbdbd
    style PVC fill:#fafafa,stroke:#bdbdbd
    style MLF fill:#fafafa,stroke:#bdbdbd
