%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#fff3e0', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#f57c00', 'lineColor': '#455a64'}}}%%
flowchart TB
    subgraph Notebook["üìì 02-training.ipynb"]
        direction TB
        
        subgraph Features["1Ô∏è‚É£ Feature Retrieval (Feast + Ray)"]
            F1["Create Entity DataFrame<br/>(store_id, dept_id, timestamp)"]
            F2["get_historical_features()<br/>(training_features service)"]
            F3["Receive Training Dataset<br/>(with point-in-time joins)"]
        end
        
        subgraph Train["2Ô∏è‚É£ Distributed Training"]
            T1["Preprocess Data<br/>(StandardScaler)"]
            T2["Train PyTorch MLP<br/>(4-layer, 2 nodes DDP)"]
            T3["Validate & Early Stop<br/>(best model selection)"]
        end
        
        subgraph Save["3Ô∏è‚É£ Save Artifacts"]
            S1["Save Model<br/>(best_model.pt)"]
            S2["Save Scalers<br/>(scalers.joblib)"]
            S3["Log to MLflow<br/>(metrics, params, model)"]
        end
    end

    subgraph Infra["Infrastructure"]
        Ray["‚ö° KubeRay<br/>(distributed PIT joins)"]
        Feast["üçï Feast<br/>Feature Store"]
        MLflow["üìà MLflow<br/>Experiment Tracking"]
        PVC[(üíæ Storage<br/>Models + Data)]
    end

    F1 --> F2 --> F3
    F3 --> T1 --> T2 --> T3
    T3 --> S1 --> S2 --> S3

    F2 --> Feast
    Feast -.->|"distributed"| Ray
    Ray -.->|"read"| PVC
    S1 --> PVC
    S2 --> PVC
    S3 --> MLflow

    Output["‚úÖ Model trained<br/>MAPE ~3%"]
    S3 --> Output

    style Notebook fill:#fff3e0,stroke:#f57c00,color:#1a1a1a
    style Features fill:#e3f2fd,stroke:#1976d2,color:#1a1a1a
    style Train fill:#fce4ec,stroke:#c2185b,color:#1a1a1a
    style Save fill:#e8f5e9,stroke:#388e3c,color:#1a1a1a
    style Infra fill:#eceff1,stroke:#607d8b,color:#1a1a1a

